<div align="center">

# ü§ñ PuzzleBot ROS 2 Framework

[![ROS2](https://img.shields.io/badge/ROS2-Humble-blue?style=flat-square&logo=ros)](https://docs.ros.org/en/humble/)
[![License](https://img.shields.io/badge/License-MIT-green?style=flat-square)](LICENSE)
[![Python](https://img.shields.io/badge/Python-3.10-yellow?style=flat-square&logo=python)](https://www.python.org/)
[![Ubuntu](https://img.shields.io/badge/Ubuntu-22.04-orange?style=flat-square&logo=ubuntu)](https://ubuntu.com/)
[![Status](https://img.shields.io/badge/Status-Active-brightgreen?style=flat-square)]()
[![Version](https://img.shields.io/badge/Version-1.3.0-informational?style=flat-square)]()

**Control avanzado para robots m√≥viles PuzzleBot usando ROS 2**  
*Seguimiento de l√≠neas, detecci√≥n de se√±ales/sem√°foros y navegaci√≥n aut√≥noma*

[üöÄ Inicio r√°pido](#-inicio-r√°pido) ‚Ä¢
[üì¶ Instalaci√≥n](#-instalaci√≥n) ‚Ä¢
[üìã Caracter√≠sticas](#-caracter√≠sticas) ‚Ä¢
[üîÑ Arquitectura](#-arquitectura-del-sistema) ‚Ä¢
[üìù Documentaci√≥n](#-documentaci√≥n) ‚Ä¢
[‚öôÔ∏è Configuraci√≥n](#-configuraci√≥n-avanzada)

<img src="https://github.com/user-attachments/assets/0a89ed5c-7f65-47a1-a0c1-a7e23c7e9249" alt="PuzzleBot" width="450px">

</div>

---

## üåü Caracter√≠sticas principales

<table>
  <tr>
    <td width="25%" align="center">
      <img src="src/assets/line_following.png" width="100"><br>
      <b>Seguimiento de l√≠neas</b><br>
      <span style="color:#00796b">Algoritmos avanzados de visi√≥n con filtrado HSV adaptativo</span>
    </td>
    <td width="25%" align="center">
      <img src="src/assets/traffic_light.png" width="100"><br>
      <b>Detecci√≥n de sem√°foros</b><br>
      <span style="color:#c62828">Reconocimiento en tiempo real con clasificaci√≥n por color</span>
    </td>
    <td width="25%" align="center">
      <img src="src/assets/traffic_signs.png" width="100"><br>
      <b>Detecci√≥n de se√±ales</b><br>
      <span style="color:#1565c0">Identificaci√≥n y respuesta a se√±ales de tr√°fico</span>
    </td>
    <td width="25%" align="center">
      <img src="src/assets/autonomous_navigation.png" width="100"><br>
      <b>Navegaci√≥n aut√≥noma</b><br>
      <span style="color:#6a1b9a">Control PID optimizado para trayectorias precisas</span>
    </td>
  </tr>
</table>

## üöÄ Inicio r√°pido

<div style="background-color: #f6f8fa; padding: 15px; border-radius: 6px; margin: 20px 0;">
<p><strong>‚è±Ô∏è En menos de 5 minutos podr√°s estar desarrollando con PuzzleBot:</strong></p>

```bash
# Clonar el repositorio
git clone https://github.com/AldonDC/puzzlebot-ros2-control.git
cd puzzlebot-ros2-control

# Configuraci√≥n autom√°tica (una sola vez)
chmod +x scripts/puzzlebot_pro.sh
./scripts/puzzlebot_pro.sh

# ¬°Comienza a trabajar con el PuzzleBot!
puzzlebot
```
</div>

## üì¶ Instalaci√≥n

### Requisitos previos

<table>
  <tr>
    <td><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/ubuntu/ubuntu-plain.svg" width="40"></td>
    <td>Ubuntu 20.04/22.04</td>
  </tr>
  <tr>
    <td><img src="![image](https://github.com/user-attachments/assets/8d2dc5fa-d339-45e4-b12e-f02a92601742)" width="40"></td>
    <td>ROS 2 Humble/Foxy</td>
  </tr>
  <tr>
    <td><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/python/python-original.svg" width="40"></td>
    <td>Python 3.8+</td>
  </tr>
  <tr>
    <td><img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/opencv/opencv-original.svg" width="40"></td>
    <td>OpenCV 4.2+</td>
  </tr>
</table>

### Instalaci√≥n autom√°tica

Nuestro framework incluye scripts de configuraci√≥n autom√°tica que detectan tu entorno y configuran todo lo necesario:

```bash
# Dar permisos de ejecuci√≥n
chmod +x scripts/puzzlebot_pro.sh

# Ejecutar configuraci√≥n
./scripts/puzzlebot_pro.sh
```

<div style="background-color: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50; margin: 20px 0;">
<p><strong>‚úÖ El script realiza autom√°ticamente:</strong></p>
<ul>
  <li>Detecci√≥n autom√°tica de la IP de tu laptop en la red 10.42.0.x</li>
  <li>Configuraci√≥n de las variables de entorno ROS_DOMAIN_ID y ROS_IP</li>
  <li>Creaci√≥n de alias √∫tiles para uso diario</li>
  <li>Verificaci√≥n de la conexi√≥n con el PuzzleBot</li>
</ul>
</div>

## üìã Caracter√≠sticas

### Sistema modular de control

<div align="center">
  <img src="https://github.com/user-attachments/assets/5fda7c41-ca0b-4f83-95e3-e315c01bb21a" alt="Componentes del sistema" width="750">
</div>

### Nodos principales

#### Control

| Nodo | Descripci√≥n | T√≥picos publicados | T√≥picos suscritos |
|------|-------------|-------------------|-------------------|
| <code style="color:#2e7d32">line_follower_controller</code> | Sigue l√≠neas mediante visi√≥n con filtrado HSV adaptativo | `/cmd_vel` | `/line_position` |
| <code style="color:#c62828">traffic_light_controller</code> | Detecta y responde a sem√°foros con transiciones suaves | `/cmd_vel` | `/traffic_light` |
| <code style="color:#0d47a1">sign_response_controller</code> | **NUEVO**: Responde a se√±ales de tr√°fico detectadas | `/cmd_vel` | `/traffic_sign`, `/odom` |
| <code style="color:#e65100">pid_controller_node</code> | Control PID optimizado para movimiento preciso | `/cmd_vel` | `/target`, `/odom` |
| <code style="color:#4527a0">path_generator_node</code> | Genera trayectorias para navegaci√≥n aut√≥noma | `/target` | `/odom` |
| <code style="color:#00695c">odometry_node</code> | C√°lculo mejorado de posici√≥n con fusi√≥n de datos | `/odom` | `/encoders` |

#### Detecci√≥n

| Nodo | Descripci√≥n | T√≥picos publicados | T√≥picos suscritos |
|------|-------------|-------------------|-------------------|
| <code style="color:#c62828">traffic_detector</code> | Detecta sem√°foros con algoritmos robustos | `/traffic_light` | `/image_raw` |
| <code style="color:#0d47a1">sign_detector</code> | **NUEVO**: Identifica se√±ales de tr√°fico (STOP, GIVE WAY, etc.) | `/traffic_sign` | `/image_raw` |
| <code style="color:#2e7d32">angular_error_node</code> | C√°lculo optimizado de error angular para navegaci√≥n precisa | `/angular_error` | `/image_raw` |
| <code style="color:#6a1b9a">debug_visualizer</code> | Visualizaci√≥n en tiempo real del procesamiento de im√°genes | `/debug_image` | `/image_raw` |

### Comandos √∫tiles

<div style="background-color: #fffde7; padding: 15px; border-radius: 6px; border-left: 4px solid #fbc02d; margin: 20px 0;">
<p><strong>üí° Comandos de uso frecuente:</strong></p>

```bash
# Activar entorno PuzzleBot
puzzlebot

# Monitorear t√≥picos
puzzlemon

# Lanzar nodos espec√≠ficos
./scripts/launch_puzzlebot.sh
```
</div>

## üîÑ Arquitectura del Sistema

### Diagrama de Comunicaci√≥n entre Nodos

<div align="center">
  <img src="src/assets/diagram.png" alt="Diagrama de Comunicaci√≥n entre Nodos" width="800">
</div>

<div style="background-color: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #2196f3; margin: 20px 0;">
<p><strong>üîç Detalles de la arquitectura:</strong></p>
<ul>
  <li>Comunicaci√≥n basada en el modelo publicador-suscriptor de ROS 2</li>
  <li>Separaci√≥n clara entre m√≥dulos de percepci√≥n, control y planificaci√≥n</li>
  <li>Flujo de datos optimizado para minimizar latencia en operaciones cr√≠ticas</li>
  <li>Dise√±o modular que permite a√±adir o modificar componentes f√°cilmente</li>
</ul>
</div>

## üîß Conexi√≥n con el PuzzleBot

El framework est√° optimizado para la red PuzzleBot donde:
- **Jetson**: IP fija en 10.42.0.2
- **Tu laptop**: IP autom√°ticamente detectada en la red 10.42.0.x

### Explicaci√≥n detallada de la configuraci√≥n ROS 2

Para garantizar la comunicaci√≥n correcta entre todos los miembros del equipo y el PuzzleBot, es importante entender c√≥mo funciona:

<div style="display: flex; gap: 20px; margin: 20px 0;">
  <div style="flex: 1; background-color: #f3e5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #9c27b0;">
    <p><strong>En la laptop de cada miembro del equipo:</strong></p>
    <pre><code>export ROS_DOMAIN_ID=0        # Mismo valor para todos
export ROS_IP=10.42.0.X       # La IP de cada laptop (diferente para cada uno)
                             # Por ejemplo: 10.42.0.91 para un miembro, 10.42.0.92 para otro</code></pre>
  </div>
  <div style="flex: 1; background-color: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50;">
    <p><strong>En la Jetson (PuzzleBot):</strong></p>
    <pre><code>export ROS_DOMAIN_ID=0        # Mismo valor que en las laptops
export ROS_IP=10.42.0.2       # IP fija de la Jetson</code></pre>
  </div>
</div>

**Puntos clave:**

1. **ROS_DOMAIN_ID** determina qu√© nodos ROS 2 pueden "verse" entre s√≠. Todos los dispositivos con el mismo DOMAIN_ID pueden comunicarse.

2. **ROS_IP** le dice a ROS 2 qu√© direcci√≥n IP usar para la comunicaci√≥n. Cada dispositivo usa su propia IP.

3. **No es necesario** configurar la IP de los otros dispositivos. ROS 2 descubre autom√°ticamente a todos los nodos en el mismo DOMAIN_ID.

El script `puzzlebot_pro.sh` configura autom√°ticamente estas variables para ti, detectando tu IP en la red 10.42.0.x y configurando el DOMAIN_ID adecuado.

### Nota importante para el equipo

<div style="background-color: #ffebee; padding: 15px; border-radius: 6px; border-left: 4px solid #f44336; margin: 20px 0;">
<p><strong>‚ö†Ô∏è Para garantizar la comunicaci√≥n entre todos los miembros del equipo y el PuzzleBot:</strong></p>
<ol>
  <li>Todos deben usar <strong>ROS_DOMAIN_ID=0</strong> al configurar con el script puzzlebot_pro.sh</li>
  <li>Todos deben estar conectados a la misma red WiFi del PuzzleBot</li>
  <li>La Jetson del PuzzleBot tiene la IP fija 10.42.0.2</li>
</ol>
</div>

## üìù Documentaci√≥n

### Estructura del repositorio

```
puzzlebot_ws/
‚îú‚îÄ‚îÄ assets/                         # Im√°genes y recursos para documentaci√≥n
‚îú‚îÄ‚îÄ build/                          # Archivos de compilaci√≥n (generados)
‚îú‚îÄ‚îÄ control_pkg/                    # Paquete de controladores
‚îÇ   ‚îú‚îÄ‚îÄ control_pkg/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ line_follower_controller.py    # Mejorado con filtrado HSV adaptativo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ traffic_light_controller.py    # Actualizado con transiciones suaves
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sign_response_controller.py    # NUEVO: Respuesta a se√±ales de tr√°fico
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pid_controller_node.py         # Control PID optimizado (COMPONENTE CR√çTICO)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ path_generator_node.py         # Generaci√≥n de trayectorias b√°sicas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ odometry_node.py               # Mejorado con fusi√≥n de datos
‚îÇ   ‚îú‚îÄ‚îÄ resource/                   # Recursos del paquete
‚îÇ   ‚îú‚îÄ‚îÄ test/                       # Pruebas unitarias
‚îÇ   ‚îú‚îÄ‚îÄ package.xml
‚îÇ   ‚îî‚îÄ‚îÄ setup.*
‚îÇ
‚îú‚îÄ‚îÄ detector_pkg/                   # Paquete de algoritmos de detecci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ detector_pkg/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ traffic_detector.py           # Algoritmo robusto de detecci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sign_detector.py              # NUEVO: Detector de se√±ales de tr√°fico
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ angular_error_node.py         # C√°lculo optimizado de error angular para correcci√≥n en eje Z
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ debug_visualizer.py           # Visualizaci√≥n para debug
‚îÇ   ‚îú‚îÄ‚îÄ resource/                   # Recursos del paquete
‚îÇ   ‚îú‚îÄ‚îÄ test/                       # Pruebas unitarias
‚îÇ   ‚îú‚îÄ‚îÄ package.xml
‚îÇ   ‚îî‚îÄ‚îÄ setup.*
‚îÇ
‚îú‚îÄ‚îÄ install/                        # Archivos de instalaci√≥n (generados)
‚îú‚îÄ‚îÄ log/                            # Registros de ejecuci√≥n
‚îú‚îÄ‚îÄ scripts/                        # Scripts de configuraci√≥n y utilidades
‚îÇ   ‚îî‚îÄ‚îÄ puzzlebot_pro.sh            # Configuraci√≥n autom√°tica
‚îÇ
‚îú‚îÄ‚îÄ .gitignore                      # Archivos ignorados por Git
‚îú‚îÄ‚îÄ LICENSE                         # Licencia MIT
‚îî‚îÄ‚îÄ README.md                       # Esta documentaci√≥n
```

### Uso de colores en terminal

El c√≥digo utiliza una clase `TerminalColors` para mejorar la visualizaci√≥n en terminal:

```python
class TerminalColors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
```

## ‚öôÔ∏è Configuraci√≥n Avanzada

### Personalizaci√≥n del entorno

Para configuraciones personalizadas, edita:
```bash
~/.puzzlebot/config.sh
```

### Par√°metros ajustables

<details>
<summary><b>‚ö° Controlador PID (Componente Cr√≠tico)</b></summary>
<ul>
  <li><b>Kp, Ki, Kd</b>: Modifica estos valores en el nodo <code>pid_controller_node.py</code> para ajustar la respuesta del robot</li>
  <li><b>Max velocidad</b>: Ajusta la velocidad m√°xima en diferentes controladores seg√∫n las capacidades de tu hardware</li>
  <li><b>Frecuencia</b>: Cambia la frecuencia de actualizaci√≥n seg√∫n tus necesidades de rendimiento y capacidad de procesamiento</li>
</ul>
</details>

<details>
<summary><b>üëÅÔ∏è Par√°metros de visi√≥n</b></summary>
<ul>
  <li><b>Rangos HSV</b>: Personaliza los rangos de color en <code>traffic_detector.py</code> y <code>sign_detector.py</code> para diferentes condiciones de iluminaci√≥n</li>
  <li><b>Umbral de detecci√≥n</b>: Ajusta la sensibilidad de los algoritmos de detecci√≥n</li>
  <li><b>Resoluci√≥n</b>: Modifica la resoluci√≥n de procesamiento para balancear rendimiento y precisi√≥n</li>
</ul>
</details>

<details>
<summary><b>üö¶ Reconocimiento de se√±ales</b></summary>
<ul>
  <li><b>Plantillas de se√±ales</b>: El sistema incluye plantillas para las se√±ales m√°s comunes (STOP, GIVE WAY, direccionales, etc.)</li>
  <li><b>Umbral de coincidencia</b>: Ajusta la precisi√≥n del reconocimiento de se√±ales</li>
  <li><b>Prioridad de se√±ales</b>: Configura qu√© se√±ales tienen precedencia cuando m√∫ltiples son detectadas</li>
</ul>
</details>

### Soluci√≥n de problemas

<details>
<summary><b>üîå No se detecta la red del PuzzleBot</b></summary>
<ul>
  <li>Aseg√∫rate de que el PuzzleBot est√© encendido</li>
  <li>Con√©ctate al hotspot WiFi del PuzzleBot</li>
  <li>Verifica en la configuraci√≥n de red que tienes una IP en el rango 10.42.0.x</li>
  <li>Ejecuta <code>ifconfig</code> para verificar tus interfaces de red</li>
</ul>
</details>

<details>
<summary><b>üîÑ No hay comunicaci√≥n entre dispositivos</b></summary>
<ul>
  <li>Ejecuta <code>ping 10.42.0.2</code> para verificar la conexi√≥n</li>
  <li>Confirma que tanto la laptop como la Jetson tienen el mismo ROS_DOMAIN_ID</li>
  <li>Verifica que no haya firewalls bloqueando la comunicaci√≥n: <code>sudo ufw status</code></li>
  <li>Reinicia el PuzzleBot si los problemas persisten</li>
</ul>
</details>

<details>
<summary><b>‚ö†Ô∏è Errores en los nodos</b></summary>
<ul>
  <li>Verifica los logs en <code>~/.ros/log/</code> o en el directorio <code>log/</code> del workspace</li>
  <li>Usa <code>ros2 topic echo /topic_name</code> para verificar si se est√°n publicando mensajes</li>
  <li>Comprueba que todos los paquetes est√°n correctamente compilados con <code>colcon build</code></li>
  <li>Verifica dependencias con <code>rosdep check --from-paths src</code></li>
</ul>
</details>

## üñ•Ô∏è Demostraciones

<div style="display: flex; gap: 20px; margin: 20px 0;">
  <div style="flex: 1; text-align: center;">
    <img src="src/assets/demo1.gif" alt="Demo 1" width="100%">
    <p><strong>Seguimiento de l√≠nea</strong></p>
  </div>
  <div style="flex: 1; text-align: center;">
    <img src="src/assets/demo2.gif" alt="Demo 2" width="100%">
    <p><strong>Detecci√≥n de sem√°foros</strong></p>
  </div>
</div>

## üë• Equipo de desarrollo

<table>
  <tr>
    <td align="center">
      <a href="https://github.com/AldonDC">
        <img src="https://github.com/identicons/AldonDC.png" width="100px;" alt=""/><br />
        <sub><b>Alfonso Sol√≠s D√≠az</b></sub>
      </a>
      <br />
      <sub>Desarrollo principal</sub>
    </td>
  </tr>
</table>

## üîç Mejoras recientes

### Versi√≥n 1.3.0 (Mayo 2025)
- **Nuevo**: Implementaci√≥n del nodo `sign_detector.py` para reconocimiento de se√±ales de tr√°fico
- **Nuevo**: Controlador `sign_response_controller.py` para responder adecuadamente a las se√±ales detectadas
- **Mejorado**: Controlador PID optimizado para navegaci√≥n m√°s precisa (componente cr√≠tico del sistema)
- **Optimizado**: C√°lculo de error angular con correcci√≥n espec√≠fica en el eje Z para seguimiento de l√≠neas m√°s limpio
- **Actualizado**: Integraci√≥n de se√±ales y sem√°foros en el sistema de control de navegaci√≥n
- **A√±adido**: Capacidad de detecci√≥n de m√∫ltiples se√±ales de tr√°fico simult√°neamente

### Pr√≥ximas funcionalidades
<div style="background-color: #e0f2f1; padding: 15px; border-radius: 6px; border-left: 4px solid #009688; margin: 20px 0;">
<p><strong>üîÆ Funcionalidades planeadas para la pr√≥xima versi√≥n:</strong></p>
<ul>
  <li>Integraci√≥n con SLAM para mapeo y localizaci√≥n</li>
  <li>Planificaci√≥n de rutas din√°micas con evitaci√≥n de obst√°culos</li>
  <li>Mejoras en el rendimiento de detecci√≥n en condiciones de baja iluminaci√≥n</li>
  <li>Interfaz gr√°fica para monitoreo y control en tiempo real</li>
</ul>
</div>

## üôè Agradecimientos

Este proyecto ha sido desarrollado en colaboraci√≥n con [**Manchester Robotics**](https://manchester-robotics.com/), quienes proporcionaron la plataforma **PuzzleBot** y un valioso soporte t√©cnico.  
Agradecemos profundamente su compromiso con la educaci√≥n en rob√≥tica y su contribuci√≥n significativa a este proyecto acad√©mico.

<div align="center">
  <a href="https://manchester-robotics.com/" target="_blank">
    <img src="https://raw.githubusercontent.com/AldonDC/puzzlebot-ros2-control/main/assets/manchester_robotics_logo.png" alt="Manchester Robotics Logo" width="300px">
  </a>
</div>

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para m√°s detalles.

<div align="center">
  <br>
  <a href="#-puzzlebot-ros2-framework">‚¨ÜÔ∏è Volver arriba ‚¨ÜÔ∏è</a>
</div>
